<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hydration Pro Clinical — Smart Web</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Almarai:wght@700;900&display=swap');

body {
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background: radial-gradient(circle at bottom center, #00ffff 0%, #0500aa 40%, #000000 100%);
  font-family:'Almarai', sans-serif;
  color:#00ffff;
  padding:10px;
  box-sizing:border-box;
}

.container {
  background: rgba(0,0,0,0.25);
  border-radius: 25px;
  box-shadow: 0 0 20px 6px aqua, 0 0 40px 14px #00ffffaa;
  width: 100%;
  max-width: 700px;
  height: 75vh;
  overflow:hidden;
  display:flex;
  flex-direction: column;
  padding: 20px;
  box-sizing:border-box;
}

.inner-container {
  padding: 10px;
  overflow-y: auto;
  height: 100%;
  scrollbar-width: none;
}
.inner-container::-webkit-scrollbar { width:0; }

.question, .result-card, .schedule-card {
  margin-bottom:15px;
  font-size:1rem;
  display:flex;
  flex-direction: column;
  transform: translateY(20px);
  opacity:0;
  transition: all 0.4s ease;
}

.question.show, .result-card.show, .schedule-card.show {
  transform: translateY(0);
  opacity:1;
}

.input-container {
  position: relative;
  width: 100%;
}

.input-container input,
.input-container select {
  padding: 12px 10px;
  width: 100%;
  border-radius: 8px;
  border: 2px solid #00ffff;
  background: rgba(0,0,0,0.25);
  color: #00ffff;
  font-size: 1rem;
  outline: none;
  box-sizing: border-box;
}

.input-container input::placeholder {
  color: rgba(0,255,255,0.6);
  font-size:0.9rem;
}

.input-container select option {
  background: #000;
  color: #00ffff;
}

.result-card, .schedule-card {
  background: rgba(0,0,0,0.4);
  border-radius:15px;
  padding:15px;
  font-size:1rem;
  line-height:1.5;
  position: relative;
}

/* جدول الترطيب النهائي */
#scheduleCard {
  padding: 18px;
  border-radius: 14px;
  background: #000; /* خلفية سوداء */
  box-shadow: 0 0 20px purple, inset 0 0 30px purple; /* ظل بنفسجي */
  color: #00ffff; /* نص أوكوا */
  font-family: Arial, sans-serif; /* خط بسيط */
}
#scheduleCard span { color: #00ffff; }

.download-btn {
  margin-top: 12px;
  align-self: center;
  background: rgba(0,0,0,0.6);
  border: 2px solid #00ffff;
  border-radius: 50%;
  width: 52px;
  height: 52px;
  font-size: 20px;
  color: #00ffff;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: 0.18s;
  user-select: none;
}
.download-btn:hover { background: #00ffff; color: #000; transform: translateY(-3px); }

.download-btn.busy { opacity: 0.7; transform: scale(0.98); pointer-events: none; }

@media (max-width:480px) {
  .container { height: auto; padding: 15px; }
  .question, .result-card, .schedule-card { font-size: 0.9rem; }
  .input-container input, .input-container select { font-size: 0.9rem; padding: 10px 8px; }
  .download-btn { width:48px; height:48px; font-size:18px; }
}
</style>
</head>
<body>
<div class="container">
  <div class="inner-container" id="questionContainer"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
// ========== الأسئلة (نفسها + إضافتين لمواعيد التمرين) ==========
const questions = [
  {text:"العمر (سنوات)", type:"number", min:1, max:120},
  {text:"الجنس", type:"select", options:["ذكر","انثى"]},
  {text:"الوزن (كجم)", type:"number", min:10, max:300},
  {text:"الطول (سم)", type:"number", min:50, max:250},
  {text:"نسبة الدهون في الجسم (%)", type:"number", min:0, max:70, default:0},
  {text:"نوع الرياضة", type:"select", options:["جري","كارديو","قوة","hiit","سباحة","مختلط","آخرى"], default:"مختلط"},
  {text:"عدد أيام التدريب أسبوعيًا", type:"number", min:0, max:14, default:3},
  {text:"متوسط مدة التمرين (دقيقة)", type:"number", min:0, max:300, default:45},
  {text:"شدة التمرين (RPE 1-10)", type:"number", min:1, max:10, default:6},
  {text:"هل تستطيع قياس التعرق؟", type:"select", options:["نعم","لا"], default:"لا"},
  {text:"الوزن قبل التمرين (كجم)", type:"number", min:10, max:300, condition:(a)=>a[9]==="نعم"},
  {text:"الوزن بعد التمرين (كجم)", type:"number", min:10, max:300, condition:(a)=>a[9]==="نعم"},
  {text:"مدة التمرين عند القياس (دقيقة)", type:"number", min:1, max:300, condition:(a)=>a[9]==="نعم"},
  {text:"كم لتر شربت أثناء التمرين؟", type:"number", min:0, max:5, step:0.1, default:0, condition:(a)=>a[9]==="نعم"},
  {text:"هل لديك تحاليل دم/بول حديثة؟", type:"select", options:["نعم","لا"], default:"لا"},
  {text:"مستوى الصوديوم في الدم (mmol/L)", type:"number", min:120, max:160, condition:(a)=>a[14]==="نعم"},
  {text:"أسمولية البول (mOsm/kg)", type:"number", min:0, max:1500, condition:(a)=>a[14]==="نعم"},
  {text:"كرياتينين (mg/dL)", type:"number", min:0, max:20, condition:(a)=>a[14]==="نعم"},
  {text:"هل تتناول مدرات بول؟", type:"select", options:["نعم","لا"], default:"لا"},
  {text:"أسماء أدوية مهمة أخرى", type:"text"},
  {text:"مكملات تتناولها", type:"text"},
  {text:"كم ملليلتر من الكافيين يوميًا؟", type:"number", min:0, max:1000, default:0},
  {text:"كم لتر من المشروبات الرياضية/الإلكترولايت يوميًا؟", type:"number", min:0, max:5, default:0},
  {text:"كم لتر ماء عادي تشرب يوميًا تقريبًا؟", type:"number", min:0, max:5, default:1},
  {text:"نسبة الفواكه والخضار من النظام الغذائي (%)", type:"number", min:0, max:100, default:30},
  {text:"كم وجبة مالحة/مصنّعة يوميًا؟", type:"number", min:0, max:10, default:1},
  {text:"درجة الحرارة المحيطة (°م)", type:"number", min:-10, max:60, default:25},
  {text:"نسبة الرطوبة (%)", type:"number", min:0, max:100, default:50},
  {text:"التمرين في الهواء الطلق؟", type:"select", options:["نعم","لا"], default:"لا"},
  {text:"كم ساعة تنام ليلًا؟", type:"number", min:0, max:12, default:7},
  {text:"هل تستيقظ عطشانًا ليلًا؟", type:"select", options:["نعم","لا"], default:"لا"},
  {text:"مرحلة الدورة (إناث فقط)", type:"select", options:["حيض","بويضة","لا","غير_مطبق"], condition:(a)=>a[1]==="انثى", default:"لا"},
  {text:"هل تصوم حاليًا؟", type:"select", options:["نعم","لا"], default:"لا"},
  {text:"لون البول صباحًا/بعد التمرين", type:"select", options:["شفاف","فاتح","غامق"], default:"فاتح"},
  {text:"كم مرة تتبول يوميًا؟", type:"number", min:0, max:20, default:6},
  {text:"هل تتبول ليلًا؟", type:"select", options:["نعم","لا"], default:"لا"},
  {text:"أعراض جفاف (صداع/تعب/تشنجات)؟", type:"select", options:["نعم","لا"], default:"لا"},
  {text:"متوسط معدل ضربات القلب أثناء التمرين (BPM)", type:"number", min:0, max:220, default:0},
  {text:"وقت الاستيقاظ (HH:MM)", type:"time", default:"06:00"},
  {text:"وقت النوم (HH:MM)", type:"time", default:"22:30"},
  // إضافة حقلي التمرين هنا في نهاية الأسئلة
  {text:"موعد بداية التمرين (HH:MM)", type:"time", default:"17:00"},
  {text:"موعد نهاية التمرين (HH:MM)", type:"time", default:"18:00"}
];

// ========== عرض الأسئلة =============
const container = document.getElementById('questionContainer');
let answers = [];
let lastAnsweredIndex = -1;

function createQuestionElement(obj, index){
  const div = document.createElement('div');
  div.classList.add('question');
  const wrapper = document.createElement('div');
  wrapper.classList.add('input-container');

  let input;
  if(obj.type==="select"){
    input = document.createElement('select');
    const placeholder = document.createElement('option');
    placeholder.value = "";
    placeholder.disabled = true;
    placeholder.selected = true;
    placeholder.textContent = obj.text;
    placeholder.style.color = "rgba(0,255,255,0.6)";
    input.appendChild(placeholder);
    obj.options.forEach(opt=>{
      const option = document.createElement('option');
      option.value = opt;
      option.textContent = opt;
      input.appendChild(option);
    });
    input.addEventListener('change', handleSelect);
  } else {
    input = document.createElement('input');
    input.type = obj.type==="time"?"time":obj.type;
    input.placeholder = obj.text;
    if(obj.type==="time"){ input.addEventListener('change', handleTimeChange); }
    else { input.addEventListener('keypress', handleEnter); }
    if(obj.default!==undefined) input.value=obj.default;
  }

  input.setAttribute('data-index', index);
  wrapper.appendChild(input);
  div.appendChild(wrapper);
  return div;
}

function validateInput(value, obj){
  if(!value && value!==0) return false;
  if(obj.type==="number"){
    const num=parseFloat(value);
    if(isNaN(num)) return false;
    if(obj.min!==undefined && num<obj.min) return false;
    if(obj.max!==undefined && num>obj.max) return false;
  }
  if(obj.type==="select") return obj.options.includes(value);
  if(obj.type==="time") return /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(value.trim());
  return true;
}

function handleEnter(e){
  if(e.key==='Enter'){
    const idx=parseInt(e.target.getAttribute('data-index'));
    const q=questions[idx];
    const val=e.target.value;
    if(!validateInput(val,q)){ alert("⚠️ إدخال غير صالح."); e.target.focus(); return; }
    answers[idx]=val;
    if(idx>lastAnsweredIndex){ lastAnsweredIndex=idx; nextQuestion(idx); }
  }
}
function handleSelect(e){ const idx=parseInt(e.target.getAttribute('data-index')); const val=e.target.value; answers[idx]=val; if(idx>lastAnsweredIndex){ lastAnsweredIndex=idx; nextQuestion(idx); } }
function handleTimeChange(e){ const idx=parseInt(e.target.getAttribute('data-index')); const val=e.target.value; if(!validateInput(val, questions[idx])){ alert("⚠️ إدخال غير صالح."); e.target.focus(); return; } answers[idx]=val; if(idx>lastAnsweredIndex){ lastAnsweredIndex=idx; nextQuestion(idx); } }

function nextQuestion(idx){
  let nextIndex=idx+1;
  while(nextIndex<questions.length){
    const nextQ=questions[nextIndex];
    if(!nextQ.condition || nextQ.condition(answers)) break;
    nextIndex++;
  }
  if(nextIndex<questions.length){
    const nextElem=createQuestionElement(questions[nextIndex],nextIndex);
    container.appendChild(nextElem);
    setTimeout(()=>nextElem.classList.add('show'),50);
    nextElem.querySelector('input,select').focus();
    nextElem.scrollIntoView({behavior:'smooth', block:'end'});
  } else { showResult(); }
}

const firstQ=createQuestionElement(questions[0],0);
container.appendChild(firstQ);
setTimeout(()=>firstQ.classList.add('show'),50);
firstQ.querySelector('input,select').focus();

// ========== وظائف مساعدة للوقت ===========
function parseHMToMinutes(hm){
  if(!hm) return null;
  const parts = hm.split(':').map(s=>parseInt(s,10));
  if(parts.length!==2 || isNaN(parts[0]) || isNaN(parts[1])) return null;
  return parts[0]*60 + parts[1];
}
function minutesToHM(mins){
  mins = ((mins % (24*60)) + (24*60)) % (24*60);
  const h = Math.floor(mins/60);
  const m = Math.floor(mins%60);
  return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
}
function addMinutesToDate(date, mins){
  return new Date(date.getTime() + mins*60000);
}

// ========== الحساب وإظهار النتائج (مع دمج التمرين) ===========
function showResult(){
  // جمع الإجابات في كائن user
  let user = {};
  questions.forEach((q,i)=> user[i] = answers[i]);

  // حساب القاعدة (نفس المعادلة الأصلية مع تعديلات طفيفة للحفاظ على سلوكك)
  let base = parseFloat(user[2] * 0.033 * 0.94); // وزن * 0.033 * تصحيح
  if(user[4] && parseFloat(user[4]) < 15) base += base*0.05;
  if(user[1]==="انثى") base -= base*0.10;
  if(user[0] > 40) base += 0.05;
  base += (parseFloat(user[6]||3)*0.2) + ((parseFloat(user[7]||45)/60)*0.8);
  if(parseFloat(user[8]||6) > 7 || parseFloat(user[44]||0) > 150) base *= 1.12;
  if(user[9]==="نعم" && user[10] && user[11]){
    let sweat = (parseFloat(user[10]) - parseFloat(user[11])) + parseFloat(user[13]||0);
    base += sweat*(parseFloat(user[6]||3)/7);
  }
  if(parseFloat(user[22]||0) > 400) base += 0.2;
  if(user[19]==="نعم") base += 0.7;
  if(user[20] && user[20].toLowerCase().includes("creat")) base += 0.25;
  if(parseFloat(user[29]||7) < 7 || user[30]==="نعم") base += 0.2;
  if(user[34]==="غامق") base += 0.5;
  if(user[36]==="نعم") base += 0.4;
  base = Math.max(2.0, Math.min(base, 6.0));
  base = Math.round(base*100)/100; // باللتر

  // عرض إجمالي الترطيب
  const div = document.createElement('div');
  div.classList.add('result-card');
  div.innerHTML = `<strong>💧 الترطيب اليومي المقدر:</strong> ${base} لتر/يوم`;
  container.appendChild(div);
  setTimeout(()=>div.classList.add('show'),50);
  div.scrollIntoView({behavior:'smooth', block:'end'});

  // إعدادات الوقت
  const wakeHM = user[45] || "06:00";
  const sleepHM = user[46] || "22:30";
  const workoutStartHM = user[47] || null; // قد تكون undefined
  const workoutEndHM = user[48] || null;

  const wakeM = parseHMToMinutes(wakeHM);
  const sleepM = parseHMToMinutes(sleepHM);
  const ws = (wakeM===null? 6*60 : wakeM);
  const ss = (sleepM===null? 22*60+30 : sleepM);

  // تحضير list الجداول الزمنية
  let events = []; // كل عنصر {timeMinutes, label, ml}

  const total_ml = Math.round(base * 1000); // إجمالي مل

  // إذا المستخدم أدخل توقيت تمرين صالح
  let workoutStartM = workoutStartHM? parseHMToMinutes(workoutStartHM) : null;
  let workoutEndM = workoutEndHM? parseHMToMinutes(workoutEndHM) : null;

  // ضبط حالة لو تمرين يمتد عبر منتصف الليل
  if(workoutStartM !== null && workoutEndM !== null){
    // nothing special; we'll use minutes arithmetic modularly
  } else {
    workoutStartM = null; workoutEndM = null;
  }

  // النسب المبدئية (قابلة للتعديل حسب مدة التمرين)
  let prePerc = 0.10;    // 10% قبل التمرين
  let duringPerc = 0.15; // 15% أثناء
  let postPerc = 0.10;   // 10% بعد
  // إذا مدة التمرين قصيرة جداً، نقلل أثناء التمرين وزود قبل/بعد
  let workoutDuration = 0;
  if(workoutStartM !== null && workoutEndM !== null){
    // حساب الفرق بالمنهج الدوري (قد يمر لليوم التالي)
    workoutDuration = ((workoutEndM - workoutStartM) + 24*60) % (24*60);
    if(workoutDuration === 0) workoutDuration = 60; // افتراضي ساعة لو نفس الوقت
    if(workoutDuration < 15){
      duringPerc = 0.05;
      prePerc = 0.12;
      postPerc = 0.13;
    } else if(workoutDuration < 30){
      duringPerc = 0.08;
      prePerc = 0.11;
      postPerc = 0.11;
    } else if(workoutDuration > 90){
      // تمرين طويل -> نزيد أثناء التمرين قليلاً
      duringPerc = 0.20;
      prePerc = 0.08;
      postPerc = 0.08;
    }
  }

  // تأكد أن مجموع النسب لا يتجاوز 0.95 (نترك بقية اليوم على الأقل)
  let fixedSum = prePerc + duringPerc + postPerc;
  if(fixedSum > 0.95){
    const scaleDown = 0.95 / fixedSum;
    prePerc *= scaleDown; duringPerc *= scaleDown; postPerc *= scaleDown;
    fixedSum = prePerc + duringPerc + postPerc;
  }

  // حساب الملي للجزء الخاص بالتمرين
  const pre_ml = Math.round(total_ml * prePerc);
  const during_ml = Math.round(total_ml * duringPerc);
  const post_ml = Math.round(total_ml * postPerc);
  const rest_ml = total_ml - (pre_ml + during_ml + post_ml);

  // تنظيم الأحداث: نحاول وضع قبل التمرين قبل بداية التمرين بـ 20-45 دقيقة (حسب طول التمرين)
  function timeBefore(startM, minutesBefore){
    return (startM - minutesBefore + 24*60) % (24*60);
  }
  function timeAfter(endM, minutesAfter){
    return (endM + minutesAfter) % (24*60);
  }

  if(workoutStartM !== null && workoutEndM !== null){
    // قبل التمرين: قبل بداية التمرين بـ preOffset
    const preOffset = Math.min(60, Math.max(15, Math.floor(workoutDuration/2))); // بين 15 و60 أو نصف المدة
    events.push({time: timeBefore(workoutStartM, preOffset), label: "قبل التمرين", ml: pre_ml});

    // أثناء التمرين: نقسم during_ml إلى جرعات كل 10-20 دقيقة
    // عدد جرعات = Math.max(1, Math.ceil(workoutDuration / 15))
    const numDuringShots = Math.max(1, Math.ceil(workoutDuration / 15));
    const perDuringShot = Math.round(during_ml / numDuringShots);
    // توزيع داخل فترة التمرين بالتساوي
    for(let i=0;i<numDuringShots;i++){
      // time = start + (i+0.5)*(duration/numShots) لتكون وسط كل جزء
      const t = (workoutStartM + Math.round((i + 0.5) * (workoutDuration / numDuringShots))) % (24*60);
      events.push({time: t, label: `أثناء التمرين (${i+1}/${numDuringShots})`, ml: perDuringShot});
    }

    // بعد التمرين: بعد نهاية التمرين بـ 10-30 دقيقة
    const postOffset = Math.min(30, Math.max(10, Math.round(workoutDuration/4)));
    events.push({time: timeAfter(workoutEndM, postOffset), label: "بعد التمرين", ml: post_ml});
  }

  // توزيع الباقي rest_ml على فترات اليوم (نقسم إلى مجموعة نُسميات ثابتة)
  // نستخدم نفس الـ windows الأساسية لكن نزيل الحقول المتعلقة بالتمرين لأننا أضفناها مسبقًا
  const dailyWindows = [
    ["استيقاظ",0.20], ["تحضير الصباح",0.06], ["إفطار",0.14], ["سناك صباحي",0.06],
    ["غداء",0.14], ["سناك بعد الظهر",0.09], /* قبل/أثناء/بعد التمرين محسوبة منفردة */ ["عشاء",0.11], ["سناك مسائي",0.05], ["قبل النوم",0.05]
  ];

  // نحسب دقائق النشاط بين الاستيقاظ والنوم
  let totalActiveMinutes = ((ss - ws) + 24*60) % (24*60);
  if(totalActiveMinutes === 0) totalActiveMinutes = 24*60;

  // نجمع الفترات غير التمرينية إلى مصفوفة ونوزع rest_ml بالتناسب
  // نتحكم بمواقعهم الزمنية: نضعهم كنقاط متساوية بين الاستيقاظ والنوم، مع تخطي منطقة التمرين (حتى لا نكرر)
  // سنقسم rest_ml إلى N أجزاء متساوية حيث N = عدد dailyWindows الصالحة
  const usableWindows = dailyWindows; // هنا نسميهم ثابتين
  const N = usableWindows.length;
  const perWindow_ml = Math.floor(rest_ml / N);
  let remainder = rest_ml - (perWindow_ml * N);

  // نحسب مواقع هذه النوافذ زمنياً كوقت = wake + i*(activeMinutes/(N+1))
  for(let i=1;i<=N;i++){
    let t = (ws + Math.round(i * (totalActiveMinutes / (N + 1)))) % (24*60);
    // إذا هذا الوقت يدخل ضمن فترة التمرين، نحركه قبل/بعد التمرين بـ10 دقائق
    if(workoutStartM !== null && workoutEndM !== null){
      // تحقق إن t داخل فترة التمرين (دائري)
      const inWorkout = ((t - workoutStartM + 24*60) % (24*60)) < workoutDuration;
      if(inWorkout){
        // نحاول إزاحته إلى ما بعد التمرين بــ postOffset+5
        t = (workoutEndM + Math.min(15, Math.round(workoutDuration/6)) + (i%3)*5) % (24*60);
      }
    }
    let amount = perWindow_ml + (remainder>0?1:0);
    if(remainder>0) remainder--;
    events.push({time: t, label: usableWindows[i-1][0], ml: amount});
  }

  // الآن نرتب الأحداث زمنياً وندمج الأحداث ذات الأوقات المتطابقة (نجمع المل)
  events.sort((a,b)=> {
    const diff = ((a.time - b.time + 24*60) % (24*60)) - ((b.time - a.time + 24*60) % (24*60));
    // simpler: compare numeric in 0..1439
    return ((a.time - b.time + 24*60) % (24*60)) - ((b.time - a.time + 24*60) % (24*60));
  });

  // تصحيح طريقة الفرز أعلاه (الطريقة السابقة غير سليمة في كل المتصفحات)، نفصل بتحويل إلى قيمة 0..1439 ثانياً
  events.sort((a,b)=> a.time - b.time);

  // دمج نفس الأوقات
  const merged = [];
  events.forEach(ev=>{
    const last = merged.length? merged[merged.length-1] : null;
    if(last && last.time === ev.time){
      last.ml += ev.ml;
      last.label = last.label + " / " + ev.label;
    } else {
      merged.push({time: ev.time, label: ev.label, ml: ev.ml});
    }
  });

  // أخيراً: إنشاء عنصر الجدول المرئي
  let scheduleDiv = document.createElement('div');
  scheduleDiv.classList.add('schedule-card');
  scheduleDiv.id = "scheduleCard";
  scheduleDiv.innerHTML = "<strong>🕒 جدول الترطيب اليومي (متضمن التمرين):</strong><br><br>";

  merged.forEach(it=>{
    const line = document.createElement('div');
    line.style.margin = "6px 0";
    line.style.display = "flex";
    line.style.justifyContent = "space-between";
    line.style.gap = "10px";
    const mlRounded = Math.round(it.ml);
    line.innerHTML = `<span style="opacity:0.9;">${minutesToHM(it.time)}</span>
                      <span style="flex:1;text-align:center;font-weight:600">${it.label}</span>
                      <span style="opacity:0.9;">${mlRounded} ml</span>`;
    scheduleDiv.appendChild(line);
  });

  // زر تحميل كما في النسخة المحسنة
  const btn = document.createElement("button");
  btn.classList.add("download-btn");
  btn.setAttribute("title", "تحميل الجدول كصورة");
  btn.innerHTML = "⬇️";

  btn.addEventListener("click", async () => {
    try {
      btn.classList.add("busy");
      btn.innerHTML = "⏳";

      // حفظ الستيلات الحالية ثم تعطيل الظلال/التأثيرات التي قد تؤثر على الصورة
      const prevBoxShadow = scheduleDiv.style.boxShadow;
      const prevTransform = scheduleDiv.style.transform;
      const prevFilter = scheduleDiv.style.filter;
      scheduleDiv.style.boxShadow = 'none';
      scheduleDiv.style.transform = 'none';
      scheduleDiv.style.filter = 'none';

      // إعداد مقياس مناسب لشاشات الموبايل/ريتينا
      const dpr = window.devicePixelRatio || 1;
      const scale = Math.max(2, Math.round(3 * dpr));

      const opts = {
        scale: scale,
        useCORS: true,
        backgroundColor: "#000000",
        scrollY: -window.scrollY,
        windowWidth: document.documentElement.clientWidth,
        windowHeight: document.documentElement.clientHeight
      };

      const canvas = await html2canvas(scheduleDiv, opts);

      // استعادة الستيلات
      scheduleDiv.style.boxShadow = prevBoxShadow;
      scheduleDiv.style.transform = prevTransform;
      scheduleDiv.style.filter = prevFilter;

      // تحويل إلى blob لتحسين التنزيل على الموبايل
      canvas.toBlob((blob) => {
        if(!blob){
          alert('حدث خطأ أثناء تجهيز الملف.');
          btn.classList.remove('busy'); btn.innerHTML = '⬇️';
          return;
        }
        const now = new Date();
        const pad = n=>n.toString().padStart(2,'0');
        const fname = `hydration_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.png`;

        // دعم متصفح IE
        if(window.navigator && window.navigator.msSaveOrOpenBlob){
          window.navigator.msSaveOrOpenBlob(blob, fname);
          btn.innerHTML = '✅';
          setTimeout(()=>{ btn.innerHTML='⬇️'; btn.classList.remove('busy'); },1200);
          return;
        }

        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = fname;
        document.body.appendChild(link);
        link.click();
        link.remove();
        URL.revokeObjectURL(url);

        btn.innerHTML = '✅';
        setTimeout(()=>{ btn.innerHTML='⬇️'; btn.classList.remove('busy'); },1200);
      }, 'image/png', 1.0);

    } catch (err) {
      console.error(err);
      alert('حدث خطأ أثناء إنشاء الصورة.');
      btn.classList.remove('busy'); btn.innerHTML = '⬇️';
    }
  });

  scheduleDiv.appendChild(btn);
  container.appendChild(scheduleDiv);
  setTimeout(()=>scheduleDiv.classList.add('show'),50);
  scheduleDiv.scrollIntoView({behavior:'smooth', block:'end'});
}
</script>
</body>
</html>
